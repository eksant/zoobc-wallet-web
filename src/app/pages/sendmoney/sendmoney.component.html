<div class="sendmoney-container">
  <h2 class="mat-h2">{{ 'Send Money' | translate }}</h2>
  <mat-card>
    <form [formGroup]="formSend" (submit)="onOpenDialogDetailSendMoney()">
      <label>{{ 'From' | translate }}</label>
      <div class="from-account" (click)="openAccountList()">
        <div class="name">
          {{ account.name }}
          <small>
            <wallet-address [value]="address"></wallet-address>
          </small>
        </div>
        <div class="balance" *ngIf="accountBalance">
          {{ accountBalance.spendablebalance / 1e8 | number: '0.0-4' }} ZBC
        </div>
      </div>

      <label>{{ 'Recepient address' | translate }}</label>
      <mat-form-field appearance="outline" class="block">
        <input matInput placeholder="{{ 'Recepient address' | translate }}..." aria-label="contacts"
          [matAutocomplete]="auto" formControlName="recipient" (keyup)="onChangeRecipient()" />
        <mat-error *ngIf="recipientForm.touched">
          <span *ngIf="recipientForm.hasError('required')">
            {{ 'Recepient is required' | translate }}
          </span>
          <span *ngIf="recipientForm.hasError('invalidAddress')">
            {{ 'ZBC Address is invalid' | translate }}
          </span>
        </mat-error>
        <mat-autocomplete #auto="matAutocomplete">
          <mat-option *ngFor="let contact of filteredContacts | async" [value]="contact.address">
            <span>{{ contact.alias }}</span> |
            <small>{{ contact.address }}</small>
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      <section class="section-save-addres">
        <mat-checkbox class="checkbox-margin" formControlName="saveAddress">
          Save to Address Book
        </mat-checkbox>
      </section>
      <mat-form-field appearance="outline" class="block" *ngIf="saveToAddreesBook.value === true">
        <input matInput type="text" formControlName="alias" placeholder="{{ 'Alias' | translate }}" />
      </mat-form-field>

      <label>{{ 'Coin amount' | translate }}</label>
      <div class="row">
        <div class="col-3">
          <mat-form-field appearance="outline" class="block">
            <mat-select [(value)]="typeCoin">
              <mat-option value="ZBC">ZBC</mat-option>
              <mat-option value="Fiat">{{currencyRate.name}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col-9">
          <mat-form-field appearance="outline" class="block" *ngIf="typeCoin === 'ZBC'">
            <input matInput type="number" formControlName="amount" placeholder="{{ 'Coin Amount' | translate }}"
              (change)="onChangeAmountField()" (keyup)="onChangeAmountField()" />
            <mat-error *ngIf="amountForm.touched">
              <span *ngIf="amountForm.hasError('required')">
                {{ 'Amount is required' | translate }}
              </span>
            </mat-error>
          </mat-form-field>
          <mat-form-field *ngIf="typeCoin === 'Fiat'" appearance="outline" class="block">
            <input matInput type="number" formControlName="amountCurrency"
              placeholder="{{ currencyRate.name }} {{ 'amount' | translate }}" (change)="onChangeAmountCurrencyField()"
              (keyup)="onChangeAmountCurrencyField()" />
            <mat-error *ngIf="amountCurrencyForm.touched">
              <span *ngIf="amountCurrencyForm.hasError('required')">
                {{ 'Amount is required' | translate }}
              </span>
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <label>{{ 'Fee' | translate }}</label>
      <div class="row">
        <div class="col-3">
          <mat-form-field appearance="outline" class="block">
            <mat-select [(value)]="typeFee">
              <mat-option value="ZBC">ZBC</mat-option>
              <mat-option value="Fiat">{{currencyRate.name}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col-9">
          <mat-form-field appearance="outline" class="block" *ngIf="typeFee === 'ZBC'">
            <input matInput type="number" formControlName="fee" placeholder="{{ 'Fee' | translate }}"
              (change)="onChangeFeeField()" (keyup)="onChangeFeeField()" />
            <mat-error *ngIf="feeForm.touched">
              <span *ngIf="feeForm.hasError('required')">
                {{ 'Fee is required' | translate }}
              </span>
            </mat-error>
          </mat-form-field>
          <mat-form-field appearance="outline" class="block" *ngIf="typeFee === 'Fiat'">
            <input matInput type="number" formControlName="feeCurr" placeholder="{{ 'Fee' | translate }}"
              (change)="onChangeFeeCurrencyField()" (keyup)="onChangeFeeCurrencyField()" />
            <mat-error *ngIf="feeFormCurr.touched">
              <span *ngIf="feeFormCurr.hasError('required')">
                {{ 'Fee is required' | translate }}
              </span>
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <button mat-flat-button color="primary" type="submit" class="block"
        [disabled]="formSend.invalid || isFormSendLoading">
        <span *ngIf="isFormSendLoading">
          <i class="fas fa-circle-notch fa-spin"></i>&nbsp;
        </span>
        <span>{{ 'Send' | translate }}</span>
      </button>
    </form>
  </mat-card>
</div>

<ng-template #popupDetailSendMoney>
  <mat-card-title>Confirm Send Money</mat-card-title>
  <mat-card class="popup">
    <mat-card-content>
      <div>
        <p>Transaction Details</p>
        <div class="divTable">
          <div class="divTableBody">
            <div class="divTableRow">
              <div class="divTableCell-1">From</div>
              <div class="divTableCell">{{ address }}</div>
            </div>
            <div class="divTableRow">
              <div class="divTableCell-1">Recepient</div>
              <div class="divTableCell">{{ recipientForm.value }}</div>
            </div>
            <div class="divTableRow">
              <div class="divTableCell-1">Total</div>
              <div class="divTableCell">
                {{ amountForm.value + feeForm.value }} ({{
                  (amountForm.value + feeForm.value) * currencyRate.value
                    | number: '0.0-4'
                }}
                {{ currencyRate.name }})
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
  <div mat-dialog-actions align="end">
    <button mat-raised-button color="warn" (click)="closeDialog()">
      Cancel
    </button>
    <button mat-raised-button color="primary" (click)="onOpenPinDialog()">
      Confirm
    </button>
  </div>
</ng-template>

<ng-template #pinDialog>
  <h3 class="mat-h3" id="modal-basic-title">
    <b>{{ 'Confirm Your Pin' | translate }}</b>
  </h3>
  <form [formGroup]="formConfirmPin" (submit)="onConfirmPin()" class="form-pin">
    <field-pins formControlName="pin" (keyup)="onTypePin()"></field-pins>
    <div class="text-center">
      <mat-error *ngIf="formConfirmPin.hasError('invalid')">
        {{ 'Pin is not match' | translate }}
      </mat-error>
      <i matPrefix class="fas fa-circle-notch fa-spin" *ngIf="isConfirmPinLoading"></i>
    </div>
  </form>
</ng-template>

<ng-template #accountDialog>
  <h3 class="mat-h3" id="modal-basic-title">
    <b>{{ 'Accounts' | translate }}</b>
  </h3>

  <div class="account-list" *ngIf="accounts">
    <mat-card *ngFor="let acc of accounts" class="account-card" (click)="onSwitchAccount(acc)">
      <div class="row" [ngClass]="account.path == acc.path ? 'row active' : 'row'">
        <div class="col-12">
          <div class="name">{{ acc.name }}</div>
          <div class="address">
            <wallet-address [value]="acc.address"></wallet-address>
          </div>
          <div class="last-tx" *ngIf="acc.lastTx.length === 0; else hasTransaction"> Last Transaction: None
          </div>
          <ng-template #hasTransaction>
            <div class="last-tx">Last Transaction :
              {{acc.lastTx['0'].timestamp | dateAgo}}
            </div>
          </ng-template>
        </div>
        <div class="col-12 text-right">
          <div class="balance">{{ acc.balance / 1e8 }} <small>ZBC</small></div>
          <div class="balance-in-currency">{{(acc.balance / 1e8 ) * currencyRate.value  | number: '0.0-4'}}
            <small>{{currencyRate.name}}</small></div>
        </div>
      </div>
    </mat-card>
  </div>
</ng-template>